name: CI/CD Pipeline (Non-Main Branches) - DISABLED

on:
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT: curamet-onboarding
  GCP_REGION: europe-west1
  REGISTRY: europe-docker.pkg.dev
  IMAGE_NAME: curamet-onboarding/demo-service/demo-app

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build & Test

    steps:
      # ========================================
      # 1. CHECKOUT CODE
      # ========================================
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ========================================
      # 2. BUILD APPLICATION
      # ========================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Lint Code
        run: npm run lint --if-present
        continue-on-error: true

      - name: Build Application
        run: npm run build --if-present

      # ========================================
      # 3. RUN TESTS
      # ========================================
      - name: Run Tests
        run: npm test --if-present
        continue-on-error: true

      # ========================================
      # 4. UPLOAD BUILD ARTIFACTS
      # ========================================
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 5

  build-and-push-image:
    runs-on: ubuntu-latest
    name: Build & Push Docker Image
    needs: build-and-test
    if: github.event_name == 'push'

    steps:
      # ========================================
      # 1. CHECKOUT CODE
      # ========================================
      - name: Checkout Code
        uses: actions/checkout@v4

      # ========================================
      # 2. AUTHENTICATE TO GCP
      # ========================================
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      # ========================================
      # 3. SETUP GOOGLE CLOUD TOOLS
      # ========================================
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker europe-docker.pkg.dev --quiet

      # ========================================
      # 4. SETUP DOCKER BUILDX
      # ========================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ========================================
      # 5. BUILD AND PUSH IMAGE
      # ========================================
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-${{ github.ref_name }}

  terraform-plan:
    runs-on: ubuntu-latest
    name: Terraform Plan (Dry-Run)
    needs: build-and-push-image
    if: github.event_name == 'push'

    steps:
      # ========================================
      # 1. CHECKOUT CODE
      # ========================================
      - name: Checkout Code
        uses: actions/checkout@v4

      # ========================================
      # 2. AUTHENTICATE TO GCP
      # ========================================
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      # ========================================
      # 3. SETUP TERRAFORM
      # ========================================
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.7.5'

      # ========================================
      # 4. TERRAFORM OPERATIONS (Plan Only)
      # ========================================
      - name: Terraform Format Check
        working-directory: terraform
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="environments/dev/backend.conf" \
            -upgrade

      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

      - name: Terraform Plan
        working-directory: terraform
        env:
          DOCKER_BUILDKIT: '1'
        run: |
          terraform plan \
            -var-file="environments/dev/terraform.tfvars" \
            -lock=false \
            -input=false

      - name: Terraform Destroy (Manual Trigger Only)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
        working-directory: terraform
        env:
          DOCKER_BUILDKIT: '1'
        run: |
          echo "⚠️  WARNING: Destroying Terraform infrastructure on ${{ github.ref_name }} branch"
          terraform destroy \
            -auto-approve \
            -input=false \
            -lock=false \
            -var-file="environments/dev/terraform.tfvars"

      # ========================================
      # 5. COMMENT TERRAFORM PLAN ON PR
      # ========================================
      - name: Comment Terraform Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ Terraform plan completed successfully for non-main branch.\n\nNo infrastructure changes will be applied on non-main branches.'
            })
