steps:
  # 1) Install deps
  - name: "gcr.io/cloud-builders/npm"
    id: "npm install"
    args: ["ci"]

  # 2) Build TS â†’ JS
  - name: "gcr.io/cloud-builders/npm"
    id: "npm build"
    args: ["run", "build"]

  # 3) Build Docker image
  - name: "gcr.io/cloud-builders/docker"
    id: "docker build"
    args:
      [
        "build",
        "-t",
        "${_AR_HOST}/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${SHORT_SHA}",
        ".",
      ]

  # 4) Push image to Artifact Registry
  - name: "gcr.io/cloud-builders/docker"
    id: "docker push"
    args:
      [
        "push",
        "${_AR_HOST}/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${SHORT_SHA}",
      ]

  # 5) Deploy to Cloud Run
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "deploy to cloud run"
    entrypoint: gcloud
    args:
      [
        "run",
        "deploy",
        "${_SERVICE_NAME}",
        "--image",
        "${_AR_HOST}/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${SHORT_SHA}",
        "--region",
        "${_REGION}",
        "--platform",
        "managed",
        "--allow-unauthenticated",
      ]
